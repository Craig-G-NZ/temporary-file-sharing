{% extends "admin/base.html" %}

{% block title %}File Management{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">File Shares</h3>
                    <a href="{{ url_for('admin.upload') }}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Files
                    </a>
                </div>
                <div class="card-body">
                    {% if shares and shares.items|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Recipient</th>
                                        <th>Files</th>
                                        <th>Size</th>
                                        <th>Created</th>
                                        <th>Expires</th>
                                        <th>Status</th>
                                        <th>Downloads</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for share in shares.items %}
                                    <tr class="{% if share.is_expired() %}table-danger{% elif share.downloaded %}table-success{% endif %}">
                                        <td>
                                            <code>{{ share.token[:12] }}...</code>
                                        </td>
                                        <td>
                                            <!-- Recipient & Notify Form (only if no recipient set) -->
                                            {% if not share.recipient_email %}
                                            <form method="post" action="{{ url_for('admin.notify_share', token=share.token) }}" class="mt-1">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="input-group input-group-sm">
                                                    <input type="email" name="recipient_email" class="form-control" placeholder="Recipient Email" required>
                                                    <button class="btn btn-warning btn-sm" type="submit" title="Send Notification">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </form>
                                            {% else %}
                                                {{ share.recipient_email }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-info text-dark">{{ share.files|length }} files</span>
                                            <small class="d-block text-muted">
                                                {% for file in share.files %}
                                                    <a href="{{ url_for('main.download_file', token=share.token, filename=file) }}"
                                                       class="btn btn-sm {% if file in share.downloaded_files %}btn-danger{% else %}btn-primary{% endif %}"
                                                       target="_blank"
                                                       title="{% if file in share.downloaded_files %}Downloaded{% else %}Not downloaded{% endif %}">
                                                        <i class="fas fa-download"></i> {{ file }}
                                                    </a>
                                                {% endfor %}
                                            </small>
                                        </td>
                                        <td>
                                            {% set total_size = share.get_total_size_bytes() %}
                                            <strong>{{ (total_size / (1024**3))|round(2) }} GB</strong>
                                            <small class="d-block text-muted">{{ total_size|format_file_size }}</small>
                                        </td>
                                        <td>
                                            <small>{{ share.created_at|format_datetime }}</small>
                                            <div class="text-muted">{{ share.created_at|time_ago }}</div>
                                        </td>
                                        <td>
                                            <small>{{ share.expires_at|format_datetime }}</small>
                                        </td>
                                        <td>
                                            {% if share.is_expired() %}
                                                <span class="badge badge-danger text-dark">Expired</span>
                                                <form method="post" action="{{ url_for('admin.reactivate_share', token=share.token) }}" class="mt-2">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button class="btn btn-sm btn-success rounded" type="submit" title="Reactivate Link">
                                                        <i class="fas fa-redo"></i> Reactivate
                                                    </button>
                                                </form>
                                            {% elif share.downloaded %}
                                                <span class="badge badge-success text-dark">Downloaded</span>
                                            {% else %}
                                                <span class="badge badge-primary text-dark">Active</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-secondary text-dark">{{ share.download_count }}</span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="{{ url_for('main.download_page', token=share.token) }}" 
                                                   class="btn btn-info btn-sm" target="_blank" title="View Download Page">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <form method="post" action="{{ url_for('admin.delete_file', token=share.token) }}" 
                                                      class="inline-form delete-share-form" data-is-expired="{{ share.is_expired()|lower }}">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-danger btn-sm" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if shares.pages > 1 %}
                        <nav aria-label="File shares pagination">
                            <ul class="pagination justify-content-center">
                                {% if shares.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.files', page=shares.prev_num) }}">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in range(1, shares.pages + 1) %}
                                    {% if page_num == shares.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.files', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if shares.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.files', page=shares.next_num) }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                        
                        <!-- Summary -->
                        <div class="mt-3">
                            <small class="text-muted">
                                Showing {{ shares.items|length }} of {{ shares.total }} file shares
                                (Page {{ shares.page }} of {{ shares.pages }})
                            </small>
                        </div>
                        
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h4>No File Shares</h4>
                            <p class="text-muted">No files have been uploaded yet.</p>
                            <a href="{{ url_for('admin.upload') }}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload First Files
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin-files.js') }}"></script>
{% endblock %}
